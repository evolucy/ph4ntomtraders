<script>
  const form = document.getElementById('tradingview-form');
  const submitBtn = document.getElementById('submit-btn');

  // Check if user already submitted in this session
  async function checkSubmission() {
    try {
      const response = await fetch('http://localhost:3000/check-submission', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await response.json();
      if (data.submitted) {
        submitBtn.disabled = true;
        submitBtn.innerText = "Already Submitted";
      }
    } catch (error) {
      console.error("Error checking submission:", error);
    }
  }

  // On form submit
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('name').value;
    const email = document.getElementById('tradingview-email').value;
    const username = document.getElementById('tradingview-username').value;
    const phone = document.getElementById('phone-number').value;
    const pricePlan = document.getElementById('price-plan').value;

    const chatID = "7976547544";  // Tera Telegram Chat ID
    const botToken = "7764818710:AAEVf-mPvtL0dMw_8rYi1iemEpkZ_PQ4GfA";  // Bot ka token

    const message = `ðŸ“Œ *New TradingView Details Submitted*\n\nðŸ‘¤ *Name:* ${name}\nðŸ“§ *Email:* ${email}\nðŸ‘¤ *Username:* ${username}\nðŸ“ž *Phone:* ${phone}\nðŸ’° *Price Plan:* ${pricePlan}`;

    try {
      // Send data to Telegram
      const telegramResponse = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: chatID, text: message, parse_mode: "Markdown" })
      });

      if (telegramResponse.ok) {
        // Save submission to server (session mein flag set karo)
        const saveResponse = await fetch('http://localhost:3000/save-submission', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (saveResponse.ok) {
          alert('Details submitted successfully! Indicator will be added to your TradingView account shortly.');
          submitBtn.disabled = true;
          submitBtn.innerText = "Already Submitted";
          window.location.href = 'congratulations.html';
        } else {
          alert('Failed to save submission. Please try again!');
        }
      } else {
        alert('Failed to send details. Please try again!');
      }
    } catch (error) {
      console.error("Error:", error);
      alert('An error occurred. Please try again!');
    }
  });

  // Check submission status on page load
  window.addEventListener('load', checkSubmission);
</script>
